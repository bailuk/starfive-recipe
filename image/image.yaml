{{- $architecture := or .architecture "riscv64" -}}
{{- $filesystem := or .filesystem "ext4" }}
{{- $imagesize := or .imagesize "2GB" }}
{{- $image := or .image "starfive" -}}
{{- $bootstart := or .bootstart "1MiB" }}
{{- $nonfree := or .nonfree "false" -}}
{{- $rootfs := or .rootfs "rootfs.tgz" }}

architecture: {{ $architecture }}

actions:
  - action: unpack
    file: {{ $rootfs }}

{{ if eq $nonfree "true" }}
  - action: run
    description: Enable non-free-firmware Debian repo
    chroot: true
    command: sed -i 's/main$/main non-free-firmware/g' /etc/apt/sources.list
{{ end }}

  - action: recipe
    recipe: include/partition.yaml
    variables:
      filesystem: {{ $filesystem }}
      image: {{ $image }}
      imagesize: {{ $imagesize }}
      bootstart: {{ $bootstart }}

  - action: filesystem-deploy
    description: Deploy filesystem onto image

  - action: overlay
    description: Kernel and u-boot overlay
    source: overlays/kernel/
    destination: /

  - action: run
    description: Install kernel
    chroot: true
    script: scripts/install-kernel.sh
    
  - action: run
    description: Cleanup filesystem
    chroot: true
    script: scripts/rootfs-cleanup.sh

